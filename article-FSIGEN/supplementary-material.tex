%%%%%%%%%%%%%%%%%%%%%%%%%%
% Supplementary material %
%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[preprint,5p,times,11pt]{elsarticle}
\biboptions{sort&compress}

\input{preamble}
\externaldocument{Enhanced-SNP-Genotyping-with-SMLR} % Link to supplementary material aux file

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Document settings %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage
\onecolumn
\pagestyle{fancy}
\fancyhf{}
\cfoot{\thepage}
\renewcommand{\headrulewidth}{1pt}
\fancyhead[LE,LO]{\hfill SUPPLEMENTARY MATERIAL \hfill}

\setcounter{equation}{0}
\setcounter{figure}{0}
\setcounter{table}{0}
\setcounter{page}{1}

\makeatletter
\renewcommand{\thesection}{S}
\renewcommand{\figurename}{Supplementary Fig.}
\renewcommand{\thefigure}{S\arabic{figure}}
\renewcommand{\tablename}{Supplementary Table}
\renewcommand{\thetable}{S\arabic{table}}
\renewcommand{\theequation}{S\arabic{equation}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% end of settings %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{document}

\section*{Supplementary material}

\subsection*{Proportionalities between relative differences}
In the following, the total number of calls is denoted $TC$, while the number of no-calls and wrong calls produced by the HID SNP Genotyper Plugin (HSG) are denoted $NC_{\text{HSG}}$ and $WC_{\text{HSG}}$, respectively.
All three are fixed numbers, i.e. constants.
The call rate ($CR_{\text{HSG}}$) and accuracy ($AC_{\text{HSG}}$) of the HSG are defined as
\begin{align*}
CR_{\text{HSG}} \, = \, \frac{TC - NC_{\text{HSG}}}{TC} \times 100, \qquad
AC_{\text{HSG}} \, = \, \frac{TC - NC_{\text{HSG}} - WC_{\text{HSG}}}{TC - NC_{\text{HSG}}} \times 100.
\end{align*}
For the SMLR model, the number of no-calls and wrong calls depend on the probability threshold $q$, so they are in general variable and can be understood as functions: $NC_{\text{SMLR}}(q)$ and $WC_{\text{SMLR}}(q)$.
In order to compare the accuracy of the SMLR model against the HSG, the $q$-threshold is set to the minimal value, $q_{NC}$, such that $NC_{\text{SMLR}}(q_{NC}) \geq NC_{\text{HSG}}$, and the resulting number of wrong calls, $WC_{\text{SMLR}}(q_{NC}) = WC_{\text{SMLR}\mid\text{HSG}}$, is used to compute the accuracy for the SMLR model.
Likewise, the call rate of the SMLR model is compared against the HSG by setting the $q$-threshold at the minimal value, $q_{WC}$, such that $WC_{\text{SMLR}}(q_{WC}) \geq WC_{\text{HSG}}$, and the resulting number of no-calls, $NC_{\text{SMLR}}(q_{WC}) = NC_{\text{SMLR}\mid\text{HSG}}$, is used to compute the call rate for the SMLR model.

\subsubsection*{Call rates and no-calls}
The proportionality at \eqref{eq:metric_CR} follows from the definitions of $CR_{\text{HSG}}$ and $CR_{\text{SMLR}\mid\text{HSG}}$:
\begin{align}
\frac{CR_{\text{SMLR}\mid\text{HSG}} - CR_{\text{HSG}}}{CR_{\text{HSG}}}
\ &= \ 
\frac{\frac{TC - NC_{\text{SMLR}\mid\text{HSG}}}{TC} \times 100 - \frac{TC - NC_{\text{HSG}}}{TC} \times 100}{\frac{TC - NC_{\text{HSG}}}{TC} \times 100} \nonumber\\
&= \ 
\frac{TC - NC_{\text{SMLR}\mid\text{HSG}} - TC + NC_{\text{HSG}}}{TC - NC_{\text{HSG}}} \nonumber\\
&= \ 
\frac{NC_{\text{HSG}} - NC_{\text{SMLR}\mid\text{HSG}}}{TC - NC_{\text{HSG}}} \nonumber\\
&= \ 
\frac{NC_{\text{HSG}}}{TC - NC_{\text{HSG}}} \times \frac{NC_{\text{HSG}} - NC_{\text{SMLR}\mid\text{HSG}}}{NC_{\text{HSG}}} \nonumber\\
\; &\propto \; 
\frac{NC_{\text{HSG}} - NC_{\text{SMLR}\mid\text{HSG}}}{NC_{\text{HSG}}}\label{eq:prop_CR}
\end{align}

\subsubsection*{Accuracies and wrong calls}
Rigorous proportionality at \eqref{eq:metric_AC} is obtained when $NC_{\text{SMLR}}(q_{NC}) = NC_{\text{HSG}}$:
\begin{align*}
\frac{AC_{\text{SMLR}\mid\text{HSG}} - AC_{\text{HSG}}}{AC_{\text{HSG}}}
\ &= \ 
\frac{\frac{TC - NC_{\text{SMLR}}(q_{NC}) - WC_{\text{SMLR}\mid\text{HSG}}}{TC - NC_{\text{SMLR}}(q_{NC})} - \frac{TC - NC_{\text{HSG}} - WC_{\text{HSG}}}{TC - NC_{\text{HSG}}}}{\frac{TC - NC_{\text{HSG}} - WC_{\text{HSG}}}{TC - NC_{\text{HSG}}}} \\
\ &= \ 
\frac{\frac{TC - NC_{\text{HSG}}}{TC - NC_{\text{SMLR}}(q_{NC})} \left(TC - NC_{\text{SMLR}}(q_{NC}) - WC_{\text{SMLR}\mid\text{HSG}}\right) - TC + NC_{\text{HSG}} + WC_{\text{HSG}}}{TC - NC_{\text{HSG}} - WC_{\text{HSG}}} \\
\ &= \ 
\frac{TC - NC_{\text{HSG}} - \frac{TC - NC_{\text{HSG}}}{TC - NC_{\text{SMLR}}(q_{NC})} WC_{\text{SMLR}\mid\text{HSG}} - TC + NC_{\text{HSG}} + WC_{\text{HSG}}}{TC - NC_{\text{HSG}} - WC_{\text{HSG}}} \\
\ &= \ 
\frac{WC_{\text{HSG}} - \frac{TC - NC_{\text{HSG}}}{TC - NC_{\text{SMLR}}(q_{NC})} WC_{\text{SMLR}\mid\text{HSG}}}{TC - NC_{\text{HSG}} - WC_{\text{HSG}}}.
\end{align*}
When $NC_{\text{SMLR}}(q_{NC}) = NC_{\text{HSG}}$ it follows that $\frac{TC - NC_{\text{HSG}}}{TC - NC_{\text{SMLR}}(q_{NC})} = 1$ and the proportionality becomes exact:
\begin{align}
\frac{AC_{\text{SMLR}\mid\text{HSG}} - AC_{\text{HSG}}}{AC_{\text{HSG}}}
\ &= \ 
\frac{WC_{\text{HSG}} - WC_{\text{SMLR}\mid\text{HSG}}}{TC - NC_{\text{HSG}} - WC_{\text{HSG}}} \nonumber\\
\ &= \ 
\frac{WC_{\text{HSG}}}{TC - NC_{\text{HSG}} - WC_{\text{HSG}}} \times \frac{WC_{\text{HSG}} - WC_{\text{SMLR}\mid\text{HSG}}}{WC_{\text{HSG}}} \nonumber\\
\; &\propto \; 
\frac{WC_{\text{HSG}} - WC_{\text{SMLR}\mid\text{HSG}}}{WC_{\text{HSG}}}.\label{eq:prop_AC}
\end{align}
As seen in Table~\ref{tab:AC_prop}, exact alignment of no-calls was obtained in more than 77\% of the cases when considering all of the data splits and models from the cross-validations in Fig.~\ref{fig:cv}.
For the remaining cases, the quotient $\frac{TC - NC_{\text{HSG}}}{TC - NC_{\text{SMLR}}(q_{NC})}$ was always close to one, yielding an approximate proportionality.

\begin{table*}
\centering
\caption{
The percentiles at which the third decimal of the quotient $\left(TC - NC_{\text{HSG}}\right) / \left(TC - NC_{\text{SMLR}}(q_{NC})\right)$ increases, calculated across all data splits and models from the cross-validations shown in Fig.~\ref{fig:cv}.
}
\label{tab:AC_prop}
\vspace{1mm}
\begin{tabular}{l*{10}{c}}
Percentile             & 77.63\% & 87.82\% & 95.14\% & 98.50\% & 99.63\% & 99.96\% & 99.998\% & 100\% \\
\hline
$\frac{TC - NC_{\text{HSG}}}{TC - NC_{\text{SMLR}}(q_{NC})}$ & 1 & 1.0011 & 1.0021 & 1.0031 & 1.0041 & 1.0050 & 1.0061 & 1.0066 \\
\end{tabular}
\end{table*}


\newpage
\subsection*{The negative log-likelihood function}
Let $\mathcal{I}_{11}$ and $\mathcal{I}_{22}$ be index sets for the observations with homozygous genotypes in allele $a_1$ and $a_2$, respectively, and let $\mathcal{I}_{12}$ be the index set for the observations with heterozygous genotypes.
Let $m \in \mathcal{I} = \mathcal{I}_{11}\cup\mathcal{I}_{22}\cup\mathcal{I}_{12}$ be a general index and define $t_m = (1, f(s_1^m), f(s_2^m))$, where $s_1^m$ and $s_2^m$ denote the allele signals for $a_1$ and $a_2$ of the observation with index $m$.
In accordance with the notation used in~\eqref{eq:posterior}, let $p_{11}^i$, $p_{22}^j$, and $p_{12}^k$ be the conditional genotype probabilities of the observations with indices $i \in \mathcal{I}_{11}$, $j \in \mathcal{I}_{22}$, and $k \in \mathcal{I}_{12}$, respectively.
To ease the notation further, define $\beta = (\beta_0,\beta_1,\beta_2)$ and $\tilde\beta = (\beta_0,\beta_2,\beta_1)$.
The likelihood for $\beta$ is
\begin{align*}
\mathcal{L}\left(\beta\right) \ = \ \prod_{i\in\mathcal{I}_{11}} p_{11}^i \prod_{j\in\mathcal{I}_{22}} p_{22}^j \prod_{k\in\mathcal{I}_{12}} p_{12}^k,
\end{align*}
and the log-likelihood can be written as
\begin{align*}
\ell\left(\beta\right)
&=\ \sum_{i\in\mathcal{I}_{11}} \log\left(p_{11}^i\right)
\ + \sum_{j\in\mathcal{I}_{22}} \log\left(p_{22}^j\right)
\ + \sum_{k\in\mathcal{I}_{12}} \log\left(p_{12}^k\right) \\
&= \ \sum_{i\in\mathcal{I}_{11}} \log\left(\frac{\exp\left(\beta \cdot t_i \right)}{1 + \exp\left(\beta \cdot t_i \right) + \exp\left(\tilde{\beta} \cdot t_i \right)}\right) \\
&\quad + \sum_{j\in\mathcal{I}_{22}} \log\left(\frac{\exp\left(\tilde{\beta} \cdot t_j \right)}{1 + \exp\left(\beta \cdot t_j \right) + \exp\left(\tilde{\beta} \cdot t_j \right)}\right) \\
&\quad + \sum_{k\in\mathcal{I}_{12}} \log\left(\frac{1}{1 + \exp\left(\beta \cdot t_k \right) + \exp\left(\tilde{\beta} \cdot t_k \right)}\right) \\
&= \ \sum_{i\in\mathcal{I}_{11}} \Bigg[ \beta \cdot t_i - \log\left(1 + \exp\left(\beta \cdot t_i \right) + \exp\left(\tilde{\beta} \cdot t_i \right)\right) \Bigg] \\
&\quad + \sum_{j\in\mathcal{I}_{22}} \Bigg[ \tilde{\beta} \cdot t_j - \log\left(1 + \exp\left(\beta \cdot t_j \right) + \exp\left(\tilde{\beta} \cdot t_j \right)\right) \Bigg] \\
&\quad - \sum_{k\in\mathcal{I}_{12}} \log\left(1 + \exp\left(\beta \cdot t_k \right) + \exp\left(\tilde{\beta} \cdot t_k \right)\right).
\end{align*}
The sums over the logarithms can be collected under the same summation sign to obtain
\begin{align*}
\ell\left(\beta\right)
&= \ \sum_{i\in\mathcal{I}_{11}} \beta \cdot t_i
\ + \sum_{j\in\mathcal{I}_{22}} \tilde{\beta} \cdot t_j
\ - \sum_{m \in \mathcal{I}} \log\left(1 + \exp\left(\beta \cdot t_m\right) + \exp\left(\tilde{\beta} \cdot t_m\right)\right).
\end{align*}
Multiplying both sides by $-1$ and writing out the dot product between the parameters and the signals, the negative log-likelihood becomes
\begin{align}\label{eq:loglikelihood}
\begin{split}
-\ell\left(\beta\right)
&= \ \sum_{m \in \mathcal{I}} \log\left(1 + e^{\beta \cdot t_m} + e^{\tilde{\beta} \cdot t_m}\right)
\ - \sum_{i\in\mathcal{I}_{11}} \beta \cdot t_i
\ - \sum_{j\in\mathcal{I}_{22}} \tilde{\beta} \cdot t_j \\
&= \ \sum_{m \in \mathcal{I}} \log\left(1 + e^{\beta_0 + \beta_1 f\left(s_1^m\right) + \beta_2 f\left(s_2^m\right)} + e^{\beta_0 \ + \beta_2 f\left(s_1^m\right) + \beta_1 f\left(s_2^m\right)}\right) \\
&\quad - \sum_{i\in\mathcal{I}_{11}} \beta_0 + \beta_1 f\left(s_1^i\right) + \beta_2 f\left(s_2^i\right) \\
&\quad - \sum_{j\in\mathcal{I}_{22}} \beta_0 + \beta_2 f\left(s_1^j\right) + \beta_1 f\left(s_2^j\right) \\
&= \ \sum_{m \in \mathcal{I}} \log\left(1 + e^{\beta_0 + \beta_1 f\left(s_1^m\right) + \beta_2 f\left(s_2^m\right)} + e^{\beta_0 \ + \beta_2 f\left(s_1^m\right) + \beta_1 f\left(s_2^m\right)}\right) \\
&\quad - \beta_0 \lvert\mathcal{I}_{11}\cup\mathcal{I}_{22}\rvert \\
&\quad - \beta_1 \left( \sum_{i\in\mathcal{I}_{11}} f\left(s_1^i\right) + \sum_{j\in\mathcal{I}_{22}} f\left(s_2^j\right) \right) \\
&\quad - \beta_2 \left( \sum_{i\in\mathcal{I}_{11}} f\left(s_2^i\right) + \sum_{j\in\mathcal{I}_{22}} f\left(s_1^j\right) \right),
\end{split}
\end{align}
where $\lvert\mathcal{I}_{11}\cup\mathcal{I}_{22}\rvert$ is the number of homozygous observations.
Note how $\beta_1$ is multiplied by a term that ideally sums the major allele signals of the homozygous genotypes, while $\beta_2$ is multiplied by a term that ideally sums the minor allele signals, which are expected to be close to zero.


\newpage
\subsection*{Technical details on the cross-validation}
Each of the six columns of plots in Supplementary Fig.~\ref{fig:cv} represents its own cross-validation.
As indicated at the top of the figure, each of the cross-validations used different collections of DNA amounts to fit and test the models.
In each cross-validation, the data was split randomly 1,000 times into disjoint pairs of fitting and testing subsets on which all of the models were validated.
The data splitting was designed to randomly select 75\% of the data within each of the indicated collections for fitting and 25\% of the data within each of the indicated collections for testing.
This design was chosen for consistency and comparability across the rows in Supplementary Fig.~\ref{fig:cv}.
When distinct DNA amounts were used for fitting and testing, the fitting and testing subsets were disjoint by nature.
When common DNA amount(s) were used, 75\% of the common data was (randomly) selected for fitting, while the rest was used for testing.


\vspace{2cm}
%\newpage
\subsection*{Additional figures}
\noindent (see next page)


\begin{landscape}
\begin{figure*}
\centering
\includegraphics[width=1.3\textwidth]{FIG_S1-two-column.jpeg}
\caption{
Parameter estimates from bootstrap analyses of the SMLR model across varying sample sizes.\\
The model was fitted with an intercept to square-root transformed allele signals from bootstrap samples drawn from the examinations of the DNA quantities indicated at the top of each plot column.
The sample size refers to the number of sampled SNP profiles per indicated DNA quantity.
Each SNP profile consists of 162~SNPs (including potential missing values).
For each sample size, thousand bootstrap samples were drawn (with replacement), and for each of these, the SMLR model was fitted to obtain the parameter estimates indicated by red and blue dots.
Blue dots indicate samples with complete separation (zero wrong calls), while red dots indicate samples without separation.
Dashed lines represent the parameter estimates from fitting the model to all of the indicated data, and dotted lines show the 10th and 90th percentiles of the bootstrap estimates.
}
\label{fig:bootstrap}
\end{figure*}
\end{landscape}



\begin{landscape}
\begin{figure*}
\centering
\includegraphics[width=1.3\textwidth]{FIG_S2-two-column.jpeg}
\caption{
Performance comparisons of six variants of the SMLR model across different DNA amounts.\\
The models were evaluated using the metrics at~\eqref{eq:metric_CR} and~\eqref{eq:metric_AC} on each of 1,000 random splits of the data, each split dividing into 75\% fitting data and 25\% test data, with DNA amounts specified in the top.
The first row of plots shows the SMLR models' reductions in no-calls~(NCs) relative to the HID SNP Genotyper Plugin~(HSG) when the SMLR models' no-call zones (in each data split) were set to the width where they made the same number of wrong calls~(WCs) as the HSG or fewer.
Similarly, the second row of plots shows the SMLR models' relative reductions in WCs when the no-call zones were set to the width where they made the same number of NCs as the HSG or fewer.
In all subplots, the reductions are ordered and labelled according to their percentile.
}
\label{fig:cv}
\end{figure*}
\end{landscape}


\begin{figure*}
\centering
\includegraphics[width=\textwidth]{FIG_S3-1.5-column.jpeg}
\caption{
The SMLR framework used for quality check of the allele balance or spotting of rare alleles.\\
The scatterplots show the major allele signal versus the adenine signal of the SNP locus rs7722456 for the DNA quantities examined in the first dilution series.
The SMLR model (solid lines) was fitted with an intercept to square-root transformed allele signals from the examinations of \SI{25}{\pg} and \SI{50}{\pg} DNA from the second dilution series.
Observations flagged by the HID SNP Genotyper Plugin for allelic imbalance concerns (MAF-flag) are marked with red crosses.
The grey areas show where the conditional genotype probabilities of the SMLR model fall below a threshold value of $q=0.99$, highlighting potential quality issues with the enclosed points.
}
\label{fig:rare}
\end{figure*}


\begin{figure*}
\centering
\includegraphics[width=\textwidth]{FIG_S4-two-column.jpeg}
\caption{
Density plots of the signal and noise for each of the four nucleotides measured at \SI{50}{\pg} and \SI{31.25}{\pg} DNA.
The left plot shows the densities of the square-root transformed signals, i.e. the measurements at the nucleotide(s) that constitute an observation's true genotype.
The right plot shows the densities of the square-root transformed noise signals, i.e. the non-zero signals at the nucleotides that aren't part of the true genotype.
}
\label{fig:s_density}
\end{figure*}

\end{document}
\endinput